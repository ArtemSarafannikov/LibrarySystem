{% extends 'base.html' %}

{% block title %}
Личный кабинет
{% endblock %}

{% block body %}
<h1>Добро пожаловать, {{ username }}</h1>
{% if fines > 0 %}
    <p>Ваш штраф: {{ fines }} руб.</p>
{% endif %}

<h2>Проверка наличия книги</h2>
<form method="POST" action="{{ url_for('check_book') }}">
    <input type="text" name="title" placeholder="Название книги" required>
    <button type="submit">Проверить</button>
</form>

<h2>Книги за вами</h2>
{% if user_books|length == 0 %}
    <p>За вами не закреплены никакие книги</p>
{% else %}
    <ul>
        {% for i in range(user_books|length) %}
            <li>{{ user_books[i].book.title }} - {{ user_books[i].book.author }}
                {% if due_days[i] < 0 %}
                    (Просрочено на <font color="red"><b>{{ -due_days[i] }} дней</b></font>)
                {% else %}
                    (Осталось <b>{{ due_days[i] }} дней до сдачи</b>)</li>
                {% endif %}
        {% endfor %}
    </ul>
{% endif %}
<h2>Забронированные книги</h2>
{% if reserved_books|length == 0 %}
    <p>Вы не бронировали книг</p>
{% else %}
    <ul>
        {% for reserved_book in reserved_books %}
            <li><b>{{ reserved_book.book.title }} - {{ reserved_book.author }}</b> забронирована до {{ reserved_book.expiration_date}} (Осталось {{ (reserved_book.expiration_date - now_date).days }} дня)
                <form method="POST" action="{{ url_for('cancel_reserve') }}">
                <input type="hidden" name=reservation_id value="{{ reserved_book.id }}">
                <button type="submit">Отменить бронь</button>
            </form>
            </li>
        {% endfor %}
    </ul>
{% endif %}

<script type="application/json" id="flash-messages">
    {{ get_flashed_messages() | tojson }}
</script>
<!--{% with messages = get_flashed_messages() %}-->
<!--    {% if messages %}-->
<!--        <ul>-->
<!--            {% for message in messages %}-->
<!--                <li>{{ message }}</li>-->
<!--            {% endfor %}-->
<!--        </ul>-->
<!--    {% endif %}-->
<!--{% endwith %}-->

<h2>Все книги</h2>
<ul>
    {% for book in books %}
        <li>{{ book.title }} -
            {% if book.available %}
                Доступна
            <form method="POST" action="{{ url_for('reserve_book') }}">
                <input type="hidden" name=book_id value="{{ book.id }}">
                <button type="submit">Забронировать</button>
            </form>
            {% else %}
                Недоступна
            {% endif %}
        </li>
    {% endfor %}
</ul>

{% if is_admin %}
    <h1>Админ панель</h1>
    <h2>Выдать книгу</h2>
    <form method="POST" action="{{ url_for('issue_book') }}">
        <input type="text" name="title" placeholder="Название книги" required>
        <input type="text" name="username" placeholder="Логин пользователя" required>
        <input type="number" name="due_days" placeholder="Количество дней на чтение" value="7" required>
        <button type="submit">Выдать книгу</button>
    </form>

    <h2>Возврат книги</h2>
    <form method="POST" action="{{ url_for('return_book') }}">
        <input type="number" name="book_id" placeholder="ID книги" required>
        <button type="submit">Вернуть книгу</button>
    </form>

    <h2>Добавить книгу</h2>
    <form method="POST" action="{{ url_for('add_book') }}">
        <input type="text" name="title" placeholder="Название книги" required>
        <input type="text" name="author" placeholder="Автор" required>
        <button type="submit">Добавить книгу</button>
    </form>

    <h2>Удалить книгу</h2>
    <form method="POST" action="{{ url_for('delete_book') }}">
        <input type="text" name="title" placeholder="Название книги" required>
        <button type="submit">Удалить книгу</button>
    </form>
{% endif %}

<a href="{{ url_for('logout') }}"><button>Выйти</button></a>

{% endblock %}